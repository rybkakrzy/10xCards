---
import Layout from '@/layouts/Layout.astro';
import { HomePage } from '@/components/home/HomePage';
import { Toaster } from '@/components/ui/sonner';

// Auth check - redirect to login if not authenticated
// @ts-ignore - Astro types not properly merged
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}
---

<Layout title="Generuj fiszki - 10xCards">
  <HomePage client:load />
  <Toaster client:only="react" />
</Layout>

  textArea.addEventListener('input', () => {
    charCount.textContent = textArea.value.length.toString();
  });

  // Generate flashcards
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const text = formData.get('text') as string;
    const level = formData.get('level') as string;

    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitButton.disabled = true;
    errorMessage.classList.add('hidden');
    flashcardsContainer.classList.add('hidden');
    loading.classList.remove('hidden');

    try {
      const response = await fetch('/api/flashcards/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text, level }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to generate flashcards');
      }

      generatedFlashcards = data.flashcards || [];
      displayFlashcards(generatedFlashcards);
      
      loading.classList.add('hidden');
      flashcardsContainer.classList.remove('hidden');
    } catch (error) {
      errorMessage.textContent = error instanceof Error ? error.message : 'Błąd generowania';
      errorMessage.classList.remove('hidden');
      loading.classList.add('hidden');
    } finally {
      submitButton.disabled = false;
    }
  });

  function displayFlashcards(flashcards: any[]) {
    flashcardsList.innerHTML = flashcards.map((card, index) => `
      <div class="border border-gray-200 rounded-lg p-4" data-index="${index}">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-sm font-medium text-gray-500">Hiszpański</p>
            <p class="text-lg font-semibold text-gray-900">${card.front}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Polski</p>
            <p class="text-lg text-gray-900">${card.back}</p>
          </div>
        </div>
        ${card.part_of_speech ? `<p class="text-sm text-gray-500 mt-2">${card.part_of_speech}</p>` : ''}
      </div>
    `).join('');
  }

  // Save all flashcards
  document.getElementById('save-all-btn')?.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/flashcards/bulk', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          flashcards: generatedFlashcards.map(card => ({
            front: card.front,
            back: card.back,
            part_of_speech: card.part_of_speech,
            ai_generated: true,
          })),
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to save flashcards');
      }

      alert('Fiszki zostały zapisane!');
      window.location.href = '/dashboard';
    } catch (error) {
      alert('Błąd podczas zapisywania fiszek');
    }
  });
</script>

