---
import MainLayout from '@/layouts/MainLayout.astro';
---

<MainLayout title="Nauka - 10xCards">
  <div class="max-w-2xl mx-auto">
    <!-- Loading State -->
      <div id="loading" class="bg-white rounded-lg shadow-lg border-t-4 border-primary p-8 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
        <p class="text-gray-600">Åadowanie fiszek...</p>
      </div>

      <!-- No Flashcards -->
      <div id="no-flashcards" class="hidden bg-white rounded-lg shadow-lg border-t-4 border-secondary p-8 text-center">
        <p class="text-xl text-gray-600 mb-4">ğŸ‰ Nie masz fiszek do powtÃ³rki!</p>
        <p class="text-gray-500 mb-6">WrÃ³Ä‡ pÃ³Åºniej lub dodaj nowe fiszki.</p>
        <a
          href="/dashboard"
          class="inline-block px-6 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-md"
        >
          WrÃ³Ä‡ do dashboardu
        </a>
      </div>

      <!-- Flashcard Display -->
      <div id="flashcard-display" class="hidden">
        <!-- Progress -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow-lg border-t-4 border-secondary">
          <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span class="font-medium">PostÄ™p</span>
            <span id="progress-text" class="font-bold text-primary">0 / 0</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progress-bar" class="bg-primary h-3 rounded-full transition-all" style="width: 0%"></div>
          </div>
        </div>

        <!-- Card -->
        <div class="bg-white rounded-lg shadow-xl border-t-4 border-primary p-8 mb-6">
          <div id="card-front" class="text-center">
            <p class="text-sm text-gray-500 mb-4 uppercase tracking-wider">PrzÃ³d karty</p>
            <p id="front-text" class="text-3xl font-bold text-gray-900 mb-4"></p>
            <p id="part-of-speech" class="text-sm text-gray-500 mb-8"></p>
            <button
              id="show-answer-btn"
              class="px-8 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-md shadow-md"
            >
              PokaÅ¼ odpowiedÅº
            </button>
          </div>

          <div id="card-back" class="hidden text-center">
            <p class="text-sm text-gray-500 mb-2 uppercase tracking-wider">PrzÃ³d</p>
            <p class="text-2xl font-bold text-gray-900 mb-4" id="front-text-back"></p>
            <hr class="my-4 border-2 border-primary/20">
            <p class="text-sm text-gray-500 mb-2 uppercase tracking-wider">TyÅ‚</p>
            <p class="text-3xl font-bold text-primary mb-8" id="back-text"></p>
          </div>
        </div>

        <!-- Answer Buttons -->
        <div id="answer-buttons" class="hidden grid grid-cols-2 gap-4">
          <button
            id="incorrect-btn"
            class="py-4 px-6 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg text-lg shadow-lg transition-all border-2 border-red-400"
          >
            âŒ Nie pamiÄ™tam
          </button>
          <button
            id="correct-btn"
            class="py-4 px-6 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg text-lg shadow-lg transition-all border-2 border-green-400"
          >
            âœ… PamiÄ™tam
          </button>
        </div>
      </div>

      <!-- Completion -->
      <div id="completion" class="hidden bg-white rounded-lg shadow-lg border-t-4 border-primary p-8 text-center">
        <p class="text-4xl mb-4">ğŸ‰</p>
        <p class="text-2xl font-bold text-primary mb-4">Åšwietna robota!</p>
        <p class="text-gray-600 mb-6">UkoÅ„czyÅ‚eÅ› wszystkie fiszki do powtÃ³rki.</p>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
            <p class="text-sm text-gray-600 font-medium">Poprawne</p>
            <p id="correct-count" class="text-3xl font-bold text-green-600">0</p>
          </div>
          <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
            <p class="text-sm text-gray-600 font-medium">BÅ‚Ä™dne</p>
            <p id="incorrect-count" class="text-3xl font-bold text-red-600">0</p>
          </div>
        </div>
        <a
          href="/dashboard"
          class="inline-block px-6 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-md shadow-md"
        >
          WrÃ³Ä‡ do dashboardu
        </a>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  let flashcards: any[] = [];
  let currentIndex = 0;
  let correctCount = 0;
  let incorrectCount = 0;
  let showingAnswer = false;

  const loading = document.getElementById('loading')!;
  const noFlashcards = document.getElementById('no-flashcards')!;
  const flashcardDisplay = document.getElementById('flashcard-display')!;
  const completion = document.getElementById('completion')!;
  const cardFront = document.getElementById('card-front')!;
  const cardBack = document.getElementById('card-back')!;
  const answerButtons = document.getElementById('answer-buttons')!;

  async function loadFlashcards() {
    try {
      const response = await fetch('/api/review');
      const data = await response.json();

      flashcards = data.flashcards || [];
      
      loading.classList.add('hidden');

      if (flashcards.length === 0) {
        noFlashcards.classList.remove('hidden');
      } else {
        flashcardDisplay.classList.remove('hidden');
        showFlashcard();
      }
    } catch (error) {
      console.error('Failed to load flashcards:', error);
      alert('BÅ‚Ä…d podczas Å‚adowania fiszek');
    }
  }

  function showFlashcard() {
    if (currentIndex >= flashcards.length) {
      showCompletion();
      return;
    }

    const card = flashcards[currentIndex];
    showingAnswer = false;

    document.getElementById('front-text')!.textContent = card.front;
    document.getElementById('front-text-back')!.textContent = card.front;
    document.getElementById('back-text')!.textContent = card.back;
    document.getElementById('part-of-speech')!.textContent = card.part_of_speech || '';

    cardFront.classList.remove('hidden');
    cardBack.classList.add('hidden');
    answerButtons.classList.add('hidden');

    updateProgress();
  }

  function showAnswer() {
    showingAnswer = true;
    cardFront.classList.add('hidden');
    cardBack.classList.remove('hidden');
    answerButtons.classList.remove('hidden');
  }

  async function submitAnswer(result: 'correct' | 'incorrect') {
    const card = flashcards[currentIndex];

    try {
      await fetch(`/api/review/${card.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ result }),
      });

      if (result === 'correct') {
        correctCount++;
      } else {
        incorrectCount++;
      }

      currentIndex++;
      showFlashcard();
    } catch (error) {
      console.error('Failed to submit answer:', error);
      alert('BÅ‚Ä…d podczas zapisywania odpowiedzi');
    }
  }

  function updateProgress() {
    const total = flashcards.length;
    const current = currentIndex + 1;
    const percentage = (currentIndex / total) * 100;

    document.getElementById('progress-text')!.textContent = `${currentIndex} / ${total}`;
    (document.getElementById('progress-bar') as HTMLElement).style.width = `${percentage}%`;
  }

  function showCompletion() {
    flashcardDisplay.classList.add('hidden');
    completion.classList.remove('hidden');
    document.getElementById('correct-count')!.textContent = correctCount.toString();
    document.getElementById('incorrect-count')!.textContent = incorrectCount.toString();
  }

  // Event listeners
  document.getElementById('show-answer-btn')?.addEventListener('click', showAnswer);
  document.getElementById('correct-btn')?.addEventListener('click', () => submitAnswer('correct'));
  document.getElementById('incorrect-btn')?.addEventListener('click', () => submitAnswer('incorrect'));

  // Load flashcards on page load
  loadFlashcards();
</script>

